InSpec ã‚’ä½¿ã£ã¦ Terraform ã§ä½œã£ãŸã‚¤ãƒ³ãƒ•ãƒ©ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹
Japan HashiCorp User Group LT
14 Jun 2018

Takaaki Furukawa
Technical Account Manager, Rakuten, Inc.

: Presenter notes

* About me

.image images/tkak.png 200 _

- Technical Account Manager at Rakuten, Inc.
- @tkak (Twitter/GitHub)
- Terraform æ­´: ï¼“å¹´ã¨ã¡ã‚‡ã£ã¨
- Terraform ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®é–‹ç™º, ConoHa (deprecated), VMware vSphere, ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹IaaS

: Presenter notes

* Terraform ã¯ä¾¿åˆ©ã ã‘ã©ã€ä¸€æ­©é–“é•ã†ã¨å¤§æƒ¨äº‹

- Terraform ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸ŠãŒã£ãŸã¨ã
- Terraform ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œã‚‹ã¨ã
- Terraform ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’é–‹ç™ºã™ã‚‹ã¨ã
- ä½•ã‹å¤‰æ›´ã‚’åŠ ãˆã‚‹ã¨ã

: Presenter notes
: Terraform ã¯ä¾¿åˆ©ãªã‚“ã ã‘ã©ã€ä¸€æ­©é–“é•ã†ã¨ã‚µãƒ¼ãƒ“ã‚¹ã¸å½±éŸ¿ã‚’ä¸ãˆã¦ã—ã¾ã„ã¾ã™

* äº‹å‰ã®æ¤œè¨¼ã‚„ãƒ†ã‚¹ãƒˆã¯å¤§äº‹ ğŸ”

- å‹•ä½œç¢ºèªã®ãŸã‚ã«ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã½ã¡ã½ã¡ã—ãŸããªã„
- ãƒ†ã‚¹ãƒˆã¯è‡ªå‹•åŒ–ã—ãŸã„ã€CIã—ãŸã„

* InSpec ã‚’ä½¿ã£ã¦ Terraform ã§ä½œã£ãŸã‚¤ãƒ³ãƒ•ãƒ©ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹

* InSpec? ğŸ¤”

: Presenter notes

* ãã‚‚ãã‚‚InSpecã¨ã¯ä½•ã‹

- Chefç¤¾ãŒé–‹ç™ºã—ã¦ã„ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ•ãƒ©ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«
- ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®ãƒã‚§ãƒƒã‚¯
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å…ƒã«ã€ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿéš›ã®çŠ¶æ…‹(è¨­å®šå†…å®¹ã‚„ãƒ—ãƒ­ã‚»ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ãªã©)ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹
- Ruby ã§é–‹ç™ºã•ã‚Œã¦ã„ã‚‹

* ä¾‹ãˆã°

- nginx ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (version 1.13.9) ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹
- nginx ã‚µãƒ¼ãƒ“ã‚¹ãŒã€è‡ªå‹•èµ·å‹•æœ‰åŠ¹ã§ã€ã‹ã¤èµ·å‹•ã—ã¦ã„ã‚‹ã‹

.code example/nginx_test.rb

* å®Ÿè¡Œæ–¹æ³•

inspecã‚³ãƒãƒ³ãƒ‰

  $ inspec exec example/nginx_test.rb -t ssh://user:pass@host:port
  Profile: tests from example/nginx_test.rb (tests from example.nginx_test.rb)
  Version: (not specified)
  Target:  ssh://user:pass@host:port

    System Package nginx
       âœ”  should be installed
       âœ”  version should eq "1.13.9"
    Service nginx
       âœ”  should be enabled
       âœ”  should be running

  Test Summary: 4 successful, 0 failures, 0 skipped

* vs. Serverspec

Serverspec

- RSpecã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ãŸã‚µãƒ¼ãƒãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- Rubyã‚„RSpecã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ã„ã‚„ã™ã„

InSpec

- Rubyã«è©³ã—ããªã„äººã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã€ã¨ã„ã†æ€æƒ³ã§ä½œã‚‰ã‚Œã¦ã„ã‚‹
- Rakefileã‚„spec_helper.rbã‚’ç”¨æ„ã—ãªãã¦ã‚‚ä½¿ãˆã‚‹
- Serverspecã«ã‚¤ãƒ³ã‚¹ãƒ‘ã‚¤ã‚¢ã•ã‚Œã¦ä½œã‚‰ã‚ŒãŸãƒ„ãƒ¼ãƒ«


_"InSpec_ _is_ _inspired_ _by_ _the_ _wonderful_ _Serverspec_ _project_
_Kudos_ _to_ _mizzy_ _and_ _all_ _contributors!"_
-- GitHub inspec/inspec

* ä»Šå¹´ï¼’æœˆ InSpec 2.0 ãŒãƒªãƒªãƒ¼ã‚¹ ğŸ‰

* What's New in InSpec 2.0

Cloud platform ã‚’ã‚µãƒãƒ¼ãƒˆ

- Azure
- AWS

å„Cloudã‚µãƒ¼ãƒ“ã‚¹ã® API ã‚’ä½¿ã£ã¦ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹

* ä¾‹: AWS

.code example/aws_test.rb

* ä¾‹: Azure

.code example/azure_test.rb

* ã¾ãšã¯ Azure ã§è©¦ã—ã¦ã¿ã‚‹ ğŸ‘½

* Azure ã® Terraform ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«

VPCã‚„Security Groupãªã©ã‚’ä½œã£ãŸå¾Œã€VMã‚’ï¼‘å°ä½œã‚‹ã‚·ãƒŠãƒªã‚ª

.link https://docs.microsoft.com/en-us/azure/virtual-machines/linux/terraform-create-complete-vm Create a complete Linux virtual machine infrastructure in Azure with Terraform

- main.tf ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ã
- terraform init & terraform apply ã®å®Ÿè¡Œ
- inspec ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
- inspec exec ã®å®Ÿè¡Œ

* terraform graph

.image azure/graph.svg 550 _

* main.tf (1)

.code azure/main.tf /^# Create Network/,/^  #/

* main.tf (2)

.code azure/main.tf /^# Create virtual machine/,/^  #/

* main.tf (3)

.code azure/main.tf /^  # ===/,/^}/

* terraform init

  $ terraform init

  Initializing provider plugins...
  - Checking for available provider plugins on https://releases.hashicorp.com...
  - Downloading plugin for provider "random" (1.3.1)...
  - Downloading plugin for provider "azurerm" (1.6.0)...

  ...

  Terraform has been successfully initialized!

  You may now begin working with Terraform. Try running "terraform plan" to see
  any changes that are required for your infrastructure. All Terraform commands
  should now work.

  If you ever set or change modules or backend configuration for Terraform,
  rerun this command to reinitialize your working directory. If you forget, other
  commands will detect it and remind you to do so if necessary.

* terraform apply

.code azure/terraform_apply.log

* InSpec ã® Profileã‚’ä½œã‚‹

.code azure/test/verify/controls/example.rb

* InSpec å®Ÿè¡Œ

.code azure/inspec_exec.log

* æ‰€æ„Ÿ

- ãƒ†ã‚¹ãƒˆæ›¸ãã®ãŒçµæ§‹å¤§å¤‰ ğŸ˜±

- Azure Resource Exporter ã‚’è¦‹ãªãŒã‚‰ã²ãŸã™ã‚‰ `azure_generic_resource` ã‚’æ›¸ãã¨ã„ã†ä½œæ¥­

.link https://resources.azure.com/

* inspec-iggy ğŸš€

* inspec-iggy

"InSpec plugin for generating compliance controls from Terraform"

- Terraform `tfstate` ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ InSpec ã® profile ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«
- InSpec-Iggy (InSpec Generate -> "IG" -> "Iggy")

* Install

  $ gem install inspec
  $ gem install inspec-iggy
  $ inspec terraform version

* å®Ÿè¡Œçµæœ

.code azure/inspec_terraform.log

* å®Ÿè¡Œçµæœ

.code azure/inspec_terraform.log

titleã—ã‹å‡ºãªã„ãƒ»ãƒ»ãƒ»ï¼ğŸ˜­

ã©ã†ã‚„ã‚‰ Azure ã¯ã¾ã å¯¾å¿œã—ã¦ãªã„ã£ã½ã„

* ã¡ãªã¿ã« AWS ã§è©¦ã—ã¦ã¿ã‚‹ã¨...

* å®Ÿè¡Œçµæœ

.code aws/inspec_terraform.log

* å®Ÿè¡Œçµæœ

.code aws/inspec_terraform.log

ã¡ã‚ƒã‚“ã¨ãƒ†ã‚¹ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹ï¼

* Test ã®å®Ÿè¡Œçµæœ

.code aws/inspec_exec.log

* Test ã®å®Ÿè¡Œçµæœ

.code aws/inspec_exec.log

AWS ğŸ˜

* ã¾ã¨ã‚

- Terraform ã§ä½œã£ãŸã‚¤ãƒ³ãƒ•ãƒ©ã‚’ InSpec ã§ãƒ†ã‚¹ãƒˆã§ãã‚‹
- InSpec 2.0 ã‹ã‚‰ AWS ã¨ Azure ã‚’ã‚µãƒãƒ¼ãƒˆ (AWS ã®æ–¹ãŒä½¿ãˆã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒå¤šã„)
- inspec-iggy ã¯ Terraform `tfstate` ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ profile ã‚’è‡ªå‹•ç”Ÿæˆã§ãã‚‹
- ãŸã ã—ã€Azure ã¯ã¾ã ã¡ã‚ƒã‚“ã¨å‹•ã‹ãªã„
- ä»–ã® Cloud Platform ã¯ã¾ã ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãªã„ã®ã§ã€contributeã™ã‚‹ãƒãƒ£ãƒ³ã‚¹ğŸ’ª

